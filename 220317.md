# ğŸ“š 2022.03.16 ê³µë¶€

## Board ê²Œì‹œíŒ

### ì˜¤ëŠ˜ ì˜¤ë¥˜ë‚œ ê²ƒ

-   bcryptë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™”í•˜ëŠ”ê±¸ ì–´ì œ í–ˆì—ˆë‹¤. ê·¼ë° ì˜¤ëŠ˜ ë‹¤ì‹œ í•´ë³´ë‹ˆê¹Œ ì•”í˜¸í™”ê°€ ë˜ì§€ ì•Šì€ ì±„ë¡œ DBì— ì €ì¥ì´ ë˜ê³ ìˆì—ˆë‹¤.

#### í•´ê²° ë°©ë²•

```javascript
// server/models/User.js

const userSchema = {
    ...
}

userSchema.pre("save", function (next) {
    // ì €ì¥í•˜ê¸°ì „ì— ì‹¤í–‰í•  ì½”ë“œ
    var user = this;
    if (user.isModified("password")) {
        // ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë ë•Œë§Œ
        bcrypt.genSalt(saltRounds, function (err, salt) {
            if (err) return next(err); // nextëŠ” ë°”ë¡œ registerë¡œ ë„˜ì–´ê°
            bcrypt.hash(user.password, salt, function (err, hash) {
                if (err) return next(err);
                user.password = hash;
                next();
            });
        });
    } else {
        // ê·¸ ì™¸ì—ëŠ” ê·¸ëƒ¥ ë‚´ë³´ë‚¸ë‹¤
        next();
    }
});

const User = mongoose.model("User", userSchema);
module.exports = { User };
```

-   ë‹¨ìˆœíˆ module.exportsë¥¼ ë§¨ ë§ˆì§€ë§‰ìœ¼ë¡œ ì˜®ê¸°ë©´ ë˜ëŠ” ë¬¸ì œì˜€ë‹¤. ì›ë˜ ì½”ë“œëŠ” userSchma.pre ì½”ë“œ ì´ì „ì— module.exports ì½”ë“œë¥¼ ë„£ì—ˆê¸° ë•Œë¬¸ì— ê·¸ ì´í›„ ì½”ë“œë“¤ì´ ì‹¤í–‰ì´ ë˜ì§€ ì•Šì€ ëª¨ì–‘ì´ë‹¤.

### ë¡œê·¸ì¸ ìš”ì²­

```javascript
// server/server.js

app.post("/api/users/login", (req, res) => {
    User.findOne({ email: req.body.email }, (err, user) => {
        if (!user) {
            return res.json({
                loginSuccess: false,
                message: "ì´ë©”ì¼ì— í•´ë‹¹í•˜ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.",
            });
        }
        user.comparePassword(req.body.password, (err, isMatch) => {
            if (!isMatch)
                return res.json({
                    loginSuccess: false,
                    message: "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.",
                });

            // ë¹„ë°€ë²ˆí˜¸ê¹Œì§€ ë§ë‹¤ë©´ í† í°ì„ ìƒì„±
            user.generateToken((err, user) => {
                if (err) return res.status(400).send(err);

                // ì •ìƒì ì¼ ê²½ìš° í† í°ì„ ì¿ í‚¤ë‚˜ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë“±ì— ì €ì¥
                // ì¿ í‚¤ì— ì €ì¥
                res.cookie("x_auth", user.token)
                    .status(200)
                    .json({ loginSuccess: true, userId: user._id });
            });
        });
    });
});
```

```javascript
// server/models/User.js

// ë¡œê·¸ì¸ - ë¹„ë°€ë²ˆí˜¸ ë¹„êµ
userSchema.methods.comparePassword = function (plainPassword, cb) {
    // ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ì™€ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ì€ì§€ í™•ì¸(ë¹„êµ) -> í‰ë¬¸ì„ ì•”í˜¸í™”í•´ì„œ ë¹„êµ
    bcrypt.compare(plainPassword, this.password, function (err, isMatch) {
        if (err) return cb(err);
        cb(null, isMatch); // ì¦‰, true
    });
};

// ë¡œê·¸ì¸ - í† í° ìƒì„±
userSchema.methods.generateToken = function (cb) {
    var user = this;
    // jsonwebtokenì„ ì´ìš©í•´ì„œ í† í° ìƒì„±
    var token = jwt.sign(user._id.toHexString(), "secretToken");
    // user._id + 'secretToken' = token ì„ í†µí•´ í† í° ìƒì„±
    // í† í° í•´ì„ì„ ìœ„í•´ 'secretToken' ì…ë ¥ -> user._id ê°€ ë‚˜ì˜´
    // í† í°ì„ ê°€ì§€ê³  ëˆ„êµ¬ì¸ì§€ ì•Œ ìˆ˜ ìˆëŠ” ê²ƒ
    user.token = token;

    user.save(function (err, user) {
        if (err) return cb(err);
        cb(null, user);
    });
};
```

-

### Auth ê¸°ëŠ¥

1. Clientì˜ Cookieì— ë‹´ê¸´ tokenì„ Serverì— ê°€ì ¸ì™€ì„œ decodeí•œë‹¤.

2. decodeí•˜ë©´ User IDê°€ ë‚˜ì˜¤ëŠ”ë°, ì´ê±¸ ì´ìš©í•´ì„œ DBì˜ User Collectionì—ì„œ ìœ ì €ë¥¼ ì°¾ê³  Serverì— ê°€ì ¸ì™”ë˜ tokenì´ ê·¸ ìœ ì €ë„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

```javascript
// server/middleware/auth.js

const { User } = require("../models/User");

let auth = (req, res, next) => {
    // í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ì—ì„œ í† í°ì„ ê°€ì ¸ì˜¨ë‹¤.
    let token = req.cookies.x_auth;

    // í† í°ì„ ë³µí˜¸í™”í•œ í›„ ìœ ì €ë¥¼ ì°¾ëŠ”ë‹¤.
    User.findByToken(token, (err, user) => {
        if (err) throw err;
        if (!user) return res.json({ isAuth: false, error: true });

        req.token = token;
        req.user = user;
        next();
    });
};

module.exports = { auth };
```

```javascript
// server/models/User.js

// auth ì¸ì¦ - ë³µí˜¸í™” (í† í°ì„ ë””ì½”ë“œ)
userSchema.statics.findByToken = function (token, cb) {
    var user = this;

    jwt.verify(token, "secretToken", function (err, decoded) {
        // ìœ ì € ì•„ì´ë””ë¥¼ ì´ìš©í•´ì„œ ìœ ì €ë¥¼ ì°¾ì€ ë‹¤ìŒì—
        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°€ì ¸ì˜¨ tokenê³¼ DBì— ë³´ê´€ëœ í† í°ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        user.findOne({ _id: decoded, token: token }, function (err, user) {
            if (err) return cb(err);
            cb(null, user);
        });
    });
};
```

```javascript
// server/server.js

app.get("/api/users/auth", auth, (req, res) => {
    // ì—¬ê¸°ê¹Œì§€ ë¯¸ë“¤ì›¨ì–´(auth.js)ë¥¼ í†µê³¼í•´ ì™”ë‹¤ëŠ” ì–˜ê¸°ëŠ” Authenticationì´ Trueë¼ëŠ” ë§
    // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ìœ ì € ì •ë³´ ì „ë‹¬
    res.status(200).json({
        _id: req.user._id,
        isAdmin: req.user.role === 0 ? false : true, // roleì´ 0ì´ë©´ ì¼ë°˜ ìœ ì €, ê·¸ì™¸ëŠ” ê´€ë¦¬ì
        isAuth: true,
        email: req.user.email,
        name: req.user.name,
        lastname: req.user.lastname,
        role: req.user.role,
        image: req.user.image,
    });
});
```
